# Reusable â€” Build and Deploy Frontend to Static Web App
#
# Builds frontend and deploys to Azure Static Web Apps.
# Handles both production deploys and PR preview environments.
# For PR previews, the SWA action reads the caller's github context
# to detect the PR number and create/destroy staging environments.
#
# Called by deploy-dev.yml (production) and pr.yml (preview + cleanup).

name: Deploy Web

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (dev, staging, prod)'
        required: true
        type: string
      action:
        description: 'SWA action: upload or close'
        required: false
        type: string
        default: 'upload'

jobs:
  deploy:
    name: Deploy Web (${{ inputs.environment }}, ${{ inputs.action }})
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        if: inputs.action == 'upload'
        uses: actions/checkout@v6

      - name: Azure login
        if: inputs.action == 'upload'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get API URL
        if: inputs.action == 'upload'
        id: api-url
        run: |
          FQDN=$(az containerapp show \
            --name __PROJECT__-app-${{ inputs.environment }} \
            --resource-group __PROJECT__-${{ inputs.environment }}-rg \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          echo "url=https://$FQDN" >> "$GITHUB_OUTPUT"

      # TODO: Add your frontend build steps here. Examples:
      #
      # React + pnpm:
      #   - uses: actions/setup-node@v6
      #     with: { node-version: '22' }
      #   - uses: pnpm/action-setup@v4
      #     with: { version: latest }
      #   - run: pnpm --dir src/web install --frozen-lockfile
      #   - env:
      #       VITE_API_URL: ${{ steps.api-url.outputs.url }}
      #     run: pnpm --dir src/web build

      - name: Deploy to Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: ${{ inputs.action }}
          app_location: src/web          # TODO: Adjust to your frontend output path
          output_location: dist           # TODO: Adjust to your build output folder
          skip_app_build: true
